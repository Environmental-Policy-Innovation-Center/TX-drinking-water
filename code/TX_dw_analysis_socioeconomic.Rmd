---
title: "TX Drinking Water Data Analysis - Socioeconomic"
author: "EmmaLi Tsai"
date: "2024-02-23"
output: html_document
---
## Loading packages 
```{r}
library(tidyverse)
library(leaflet)
library(sf)
library(aws.s3)
```

## Loading data lists 
```{r}
# reading demographic, environmental (gw and sw), water delivery system (wds)
# and financial lists generated in TX_dw_collating: 
demo <- aws.s3::s3read_using(readRDS, 
                            object = "s3://tech-team-data/state-drinking-water/TX/clean/TX_demographic_list.RData")
enviro_sw <- aws.s3::s3read_using(readRDS, 
                            object = "s3://tech-team-data/state-drinking-water/TX/clean/TX_enviro_surface_list.RData")
enviro_gw <- aws.s3::s3read_using(readRDS, 
                            object = "s3://tech-team-data/state-drinking-water/TX/clean/TX_enviro_ground_list.RData")
wds <- aws.s3::s3read_using(readRDS, 
                            object = "s3://tech-team-data/state-drinking-water/TX/clean/TX_water_delivery_list.RData")
fin <- aws.s3::s3read_using(readRDS, 
                            object = "s3://tech-team-data/state-drinking-water/TX/clean/TX_financial_list.RData")

keys <- aws.s3::s3read_using(readRDS, 
                            object = "s3://tech-team-data/state-drinking-water/TX/clean/TX_merging_keys_list.RData")

crosswalk <- aws.s3::s3read_using(read.csv, 
                                  object = "s3://tech-team-data/pws_crosswalk/pws_census_tract_weighted_crosswalk.csv")
```

## East TX flag: 
```{r}
census <- demo$census
aff <- fin$TX_affordability_DAC %>%
  as.data.frame() %>%
  select(-c(geometry, estimate_mhi))

# comment out code below and don't run if not focusing just on East TX:
census <- census %>%
  filter(east_tx_flag == "yes")
# for the hcf anaylsis: 
aff <- fin$TX_affordability_DAC %>%
  as.data.frame() %>%
  select(-c(geometry, estimate_mhi)) %>%
  filter(pwsid %in% census$pwsid)
```

## What proportion of rate payers are delinquent in payments?
```{r}
# I don't think we have this data - perhaps we could use the 
# water affordability data as a way to get at this question?
```

## How have water utilities been funded historically? 
```{r}
# metadata for these columns: 
#   - gpr = green project reserve, a capitalization grant that may be used for 
#           projects to address green infrastructure, water, or energy
#           efficiency improvements. This is how much of the project's total 
#           cost is applicable to the GPR. 

# NOTE - pwsid is NOT UNIQUE to entity name! So you may have an entity name 
# (Corix Utilities, for example), that matches to ~8 pwsids

# oof this data is ~messy~ 
iup <- fin$TX_PPL_SFY14_24 %>%
  rename(pwsid = pws_id)

# gotta fix weird pwsids
for(i in 1:nrow(iup)){
  # fill ones with 7 characters, which we can confidently fix: 
  if(nchar(iup$pwsid[i]) %in% c(7)) {
      iup$pwsid[i] <- paste0("TX", iup$pwsid[i], collapse = "")
  }
}

# There's a couple of pwsids in sfy14 that have very ugly pwsids that can't 
# be fixed using the loop above - will require some string matching: 
# creating a flag for PWSIDS that need to be checked 
iup <- iup %>%
  mutate(pwsid_flag = case_when(
    nchar(pwsid) != 9 ~ "flag", 
    pwsid == "TXPending" ~ "flag", 
    TRUE ~ "NA"
  )) %>%
  mutate(pwsid = toupper(pwsid), 
         pwsid = str_squish(pwsid),
         pwsid = gsub(" ", "", pwsid))

# how many do we have to match? 124 
# let's see if we can match with previous name combos: 
all_pwsid_name_combos <- iup %>%
  select(pwsid, entity, population, pwsid_flag) %>%
  filter(pwsid_flag != "flag") %>%
  select(-pwsid_flag) %>%
  unique()

# what are the matching pwsid names from the sabs dataset?
pwsid_names <- demo$census %>%
  as.data.frame() %>%
  select(pwsid, pws_name) %>%
  unique()

iup_sab_names <- merge(all_pwsid_name_combos, pwsid_names, 
                       by = "pwsid", all.x = T)

# merging back with iups: 
iup_tidy <-  merge(iup, iup_sab_names, by = c("entity", "population"), 
                   all.x = T) %>%
  mutate(pwsid_tidy = case_when(
    (nchar(pwsid.x != 9) | (pwsid.x == "TXPENDING")) ~ pwsid.y, 
    TRUE ~ pwsid.x
  ))

# really ~ 50 entities that didn't match nicely 
iup_tidy %>%
  count(entity)


### Grabbing basic stats: ###
# Did they apply (count)? 
# Were they awarded (count)
# How much they were awarded (amount)

main_stats <- iup_tidy %>%
  # fixing two TBD values from TXPENDING
  mutate(project_cost = gsub("TBD*", "", project_cost), 
         gpr = gsub("TBD*", "", gpr), 
         project_cost = gsub("\\*", "", project_cost), 
         gpr = gsub("\\*", "", gpr), 
         project_cost_tidy = readr::parse_number(project_cost), 
         gpr_tidy = readr::parse_number(gpr), 
         disadv = readr::parse_number(disadv), 
         disadv = case_when(is.na(disadv) ~ 0, 
                                  TRUE ~ disadv)) %>%
  group_by(sfy, invited) %>%
  summarize(total_applied = length(unique(pwsid_tidy)), 
            amt_awarded = mean(project_cost_tidy, na.rm = T), 
            gpr_awarded = mean(gpr_tidy, na.rm = T), 
            mean_dac = mean(disadv)) %>%
  mutate(invited = case_when( 
    invited == "Yes" ~ "Invited", 
    TRUE ~ "Not Invited"
    )) 
  # pivot_wider(names_from = invited, values_from = total_applied:gpr_awarded) %>%
  # select(-c("amt_awarded_Not Invited", "gpr_awarded_Not Invited")) %>%
  # mutate(total_applied = `total_applied_Invited` + `total_applied_Not Invited`)

main_stats_long <- pivot_longer(main_stats, total_applied:mean_dac)
main_stats_long$name <- as.factor(main_stats_long$name)
levels(main_stats_long$name) <- c("Project Cost ($)", 
                                   "GPR ($)", 
                                   "Mean %DAC", 
                                   "Number of Projects")

ggplot(main_stats_long, aes(x = sfy, y = value, group = invited, 
                            color = invited)) + 
  geom_point() + 
  facet_wrap(~name, scales = "free") + 
  geom_line() + 
  scale_color_discrete(name = "") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust=1)) + 
  labs(x = "State Fiscal Year", 
       y = "Value")


# doing the same for East TX: 
etx_pwsids <- keys$analysis_keys %>%
  filter(east_tx_flag == "yes")
etx_main_stats <- iup_tidy %>%
  filter(pwsid_tidy %in% etx_pwsids$pwsid) %>%
  # fixing two TBD values from TXPENDING
  mutate(project_cost = gsub("TBD*", "", project_cost), 
         gpr = gsub("TBD*", "", gpr), 
         project_cost = gsub("\\*", "", project_cost), 
         gpr = gsub("\\*", "", gpr), 
         project_cost_tidy = readr::parse_number(project_cost), 
         gpr_tidy = readr::parse_number(gpr), 
         disadv = readr::parse_number(disadv), 
         disadv = case_when(is.na(disadv) ~ 0, 
                                  TRUE ~ disadv)) %>%
  group_by(sfy, invited) %>%
  summarize(total_applied = length(unique(pwsid_tidy)), 
            amt_awarded = mean(project_cost_tidy, na.rm = T), 
            gpr_awarded = mean(gpr_tidy, na.rm = T), 
            mean_dac = mean(disadv)) %>%
  mutate(invited = case_when( 
    invited == "Yes" ~ "Invited", 
    TRUE ~ "Not Invited"
    )) 
  # pivot_wider(names_from = invited, values_from = total_applied:gpr_awarded) %>%
  # select(-c("amt_awarded_Not Invited", "gpr_awarded_Not Invited")) %>%
  # mutate(total_applied = `total_applied_Invited` + `total_applied_Not Invited`)

etx_main_stats_long <- pivot_longer(etx_main_stats, total_applied:mean_dac)
etx_main_stats_long$name <- as.factor(etx_main_stats_long$name)
levels(etx_main_stats_long$name) <- c("Project Cost ($)", 
                                   "GPR ($)",  
                                   "Mean %DAC", 
                                   "Number of Projects")

ggplot(etx_main_stats_long, aes(x = sfy, y = value, group = invited, 
                            color = invited)) + 
  geom_point() + 
  facet_wrap(~name, scales = "free") + 
  geom_line() + 
  scale_color_discrete(name = "") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust=1)) + 
  labs(x = "State Fiscal Year", 
       y = "Value")
```

## What races/ethnicities are served by what system? 
```{r}
race_stats <- census %>%
  select(pwsid, estimate_white_alone_per:estimate_mixed_alone_per, 
         estimate_poc_alone_per, estimate_hisp_alone_per, estimate_mhi) %>%
  as.data.frame(.) %>%
  select(-geometry) 

# grabbing summary stats: 
colMeans(race_stats %>% select(-pwsid), na.rm = TRUE)
summary(census)

# long format for plotting: 
race_long <- race_stats %>%
  pivot_longer(., estimate_white_alone_per:estimate_mhi)

race_long$name <- as.factor(race_long$name)
levels(race_long$name) <- c("AIAN", "Asian", "Black", 
                            "Latino/a", "MHI", "Mixed", 
                            "NAPI", "Other", "POC", 
                            "White")

# histograms of % each race bin: 
options(scipen=10000)
ggplot(race_long, aes(x = value, color = name, fill = name)) + 
  geom_histogram() + 
  facet_wrap(~name, scales = "free", ncol = 5) + 
  theme_minimal() +
  scale_color_discrete(name = "") + 
  scale_fill_discrete(name = "") + 
  theme(legend.position = "bottom") + 
  labs(x = "Percent", y = "Count of PWSIDs") + 
  theme(axis.text.x = 
          element_text(angle = 90, 
                       vjust = 0.5, 
                       hjust=1)) 

# making another histogram showing racial breakdown histograms but comparing 
# east TX: 
race_stats_TX <- demo$census %>%
  select(pwsid, estimate_white_alone_per:estimate_mixed_alone_per, 
         estimate_poc_alone_per, estimate_hisp_alone_per, estimate_mhi) %>%
  as.data.frame(.) %>%
  select(-geometry) %>%
  pivot_longer(., estimate_white_alone_per:estimate_mhi) %>%
  mutate(flag = "TX")

# re facotoring names for plotting: 
race_stats_TX$name <- as.factor(race_stats_TX$name)
levels(race_stats_TX$name) <- c("AIAN", "Asian", "Black", 
                                "Latino/a", "MHI", "Mixed", 
                                "NAPI", "Other", "POC", 
                                "White")
race_long <- race_long %>%
  mutate(flag = "East TX")

all_race <- rbind(race_stats_TX, race_long)

ggplot(all_race, aes(x = value, color = flag, fill = flag)) + 
  geom_histogram(data = subset(all_race, flag == "TX"), 
                 postion = "identity", 
                 alpha = 0.1) + 
  geom_histogram(data = subset(all_race, flag == "East TX"), 
                 postion = "identity", 
                 alpha = 0.1) + 
  facet_wrap(~name, scales = "free", ncol = 5) + 
  theme_minimal() +
  scale_color_discrete(name = "") + 
  scale_fill_discrete(name = "") + 
  theme(legend.position = "bottom") + 
  labs(x = "Percent", y = "Count of PWSIDs") + 
  theme(axis.text.x = 
          element_text(angle = 90, 
                       vjust = 0.5, 
                       hjust=1)) 


# combining this info with violations: 
analysis_keys <- keys$analysis_keys
race_viols_wide <- merge(race_stats, analysis_keys, by = "pwsid") 
race_viols <- merge(race_long, analysis_keys, by = "pwsid") 

race_viol_long <- pivot_longer(race_viols, cols = paperwork_violations_10yr:total_violations_5yr, 
                               names_to = "viol_type", values_to = "total_viols")

ggplot(race_viol_long %>% filter(viol_type %in% c("healthbased_violations_10yr", 
                                                  "healthbased_violations_5yr")), 
       aes(x = value, y = total_viols, color = viol_type)) +
  geom_point() + 
  facet_wrap(~name, scales = "free") + 
  scale_color_discrete(name = "") +
  labs(x = "% Population of Race", y = "Total Violations") + 
  theme_minimal() + 
  theme(legend.position = "bottom")

# calculating and distribution of violations across different race bins: 
# race_bin_stats <- c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)
races <- race_viols_wide %>%
  select(estimate_white_alone_per:estimate_hisp_alone_per) %>%
  names()

race_viol_breakdown <- data.frame()
for(i in 1:length(races)){
  race_i <- races[i]
  message(race_i)
  
  # method for looking at quantiles: 
  race_alone_bins <- race_viols_wide %>%
    as.data.frame() %>%
    select(-geometry) %>%
    mutate(poc_bin = cut(!!sym(race_i), 
                         breaks = c(unique(quantile(!!sym(race_i), 
                                             probs = seq(0, 1, by = 0.20),
                                             na.rm = T))), 
                         include.lowest = TRUE)) %>%
    group_by(poc_bin) %>%
    summarize(total_utilities = n(),
              paperwork_10yr = mean(paperwork_violations_10yr), 
              paperwork_5yr = mean(paperwork_violations_5yr), 
              health_10yr = mean(healthbased_violations_10yr), 
              health_5yr = mean(healthbased_violations_5yr), 
              mean_mhi = mean(estimate_mhi.x, na.rm = T)) %>%
    mutate(race = race_i, 
           quantile = ntile(poc_bin, n = length(unique(poc_bin)))) 
  race_viol_breakdown <- rbind(race_viol_breakdown, race_alone_bins)
  
  # method for doing just bins: 
  # race_alone_bins <- race_viols_wide %>%
  #   as.data.frame() %>%
  #   select(-geometry) %>%
  #   mutate(poc_bin = cut(!!sym(race_i), race_bin_stats)) %>%
  #   group_by(poc_bin) %>%
  #   summarize(total_utilities = n(),
  #             paperwork_10yr = mean(paperwork_violations_10yr), 
  #             paperwork_5yr = mean(paperwork_violations_5yr), 
  #             health_10yr = mean(healthbased_violations_10yr), 
  #             health_5yr = mean(healthbased_violations_5yr)) %>%
  #   mutate(race = race_i)
}

# this is the general final takeaway for race stats: 
race_viol_breakdown


# just focusing on health-based 
race_5yr_healthbased <- race_viol_breakdown %>%
  select(poc_bin, health_5yr, race) %>%
  pivot_wider(., names_from = race, values_from = health_5yr) 

names(race_5yr_healthbased) <- c("%Race", "White_Viol", "Black_Viol", 
                                 "AIAN_Viol", "Asian_Viol", "NAPI_Viol", 
                                 "Other_Viol", "Mixed_Viol", "POC_Viol", 
                                 "Hisp_Viol")

race_5yr_healthbased
# NOTE: this tibble is not as pretty when you look at the data by quantiles, 
# since the quantiles are different by race. Regardless, it's still a helpful
# visual aid. 

# wanna plot this as well: 
poc_pal <- colorNumeric(
  palette = viridis::viridis(20),
  domain = c(0, 60))

leaflet() %>%
  addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite") %>%
  addPolygons(data = census,
              fillOpacity = 0.9,
              stroke = TRUE,
              color = "black",
              # color = ~poc_pal(estimate_poc_alone_per),
              fillColor = ~poc_pal(estimate_poc_alone_per),
              weight = 1,
              label = paste0("pwsid: ", census$pwsid,
                             "; poc: ", census$estimate_poc_alone_per)) %>%
  addLegend("bottomright",
            pal = poc_pal,
            values =  census$estimate_poc_alone_per,
            title = "% POC",
            opacity = 1)



# Overall summary: 
# - Texas is pretty segregated - % white alone is generally greater than 75%, 
#   and very little mixing between white and other races (i.e., the spread of 
#   races looks parabolic)

# - White alone: most fall into the 70-90% white category. Mean health-based 
#   viols over the past 10 years increase as % white increases, but this is also 
#   because there are more utilities that fall within this category. 
#   Same trend is also found with 5-yr health-based violations

# - Black alone: most utilities fall within the 0-10% black. Mean health-based
#   violations over the past 10 years are highest from 0-20% black communities
#   but also peaks around 30-40% and 70-80% (but this n = 1). 

# - Asian alone: similar to findings above, average number of health-based 
#   violations over the past 10 years are highest around 0-10% Asian, same 
#   trend is found with 5-yr violations 

# - Latino/Latina: 30-40% latino/latina communities have fairly high rate of 
#   mean violations, but also larger peak around 0-20%, and 90-100%

# - MHI - generally centered around ~60k - and also has a lot of health-based 
#   violations that mirror this distribution 
# 
# When looking at quanitles: 
#   - Utilities that fall within the highest 20% of percent white (89.2- 100%) 
#     have more mean health-based violations (1.72) 
# 
#   - Utilities that fall within 60-80% quantile of latino/a populations have 
#     the highest mean health-based violations. 

```


## What are the education levels of those served? 
```{r}
# grabbing some basic stats: 
mean(census$estimate_no_school_per, na.rm = T)
median(census$estimate_no_school_per, na.rm = T)

mean(census$estimate_prof_degree_per, na.rm = T)
median(census$estimate_prof_degree_per, na.rm = T)

# grabbing % of population without any schooling, and those with a prof
# degree
edu_level <- census %>%
  select(pwsid, estimate_no_school_per:estimate_prof_degree_per) %>%
  as.data.frame() %>%
  select(-geometry)

# merging with analysis keys for main stats of interest: 
analysis_keys <- keys$analysis_keys
edu_level_analysis <- merge(edu_level, analysis_keys, by = "pwsid") 

# what do these distributions look like?
edu_level_analysis_long <- edu_level_analysis %>%
  select(pwsid, estimate_no_school_per, estimate_prof_degree_per) %>%
  pivot_longer(estimate_no_school_per:estimate_prof_degree_per)
ggplot(edu_level_analysis_long, aes(x = value, fill = name)) + 
  geom_histogram() + 
  theme_minimal()

# grabbing a table to see how these relate to education levels: 
edu_bin_stats <- seq(0, 20, by = 2)

no_school <- edu_level_analysis %>%
    as.data.frame() %>%
    select(-geometry) %>%
  mutate(edu_bin = cut(estimate_no_school_per, 
                             breaks = c(quantile(estimate_no_school_per, 
                                                 probs = seq(0, 1, by = 0.20), 
                                                 na.rm = TRUE)), 
                             include.lowest = TRUE)) %>%
  group_by(edu_bin) %>%
  summarize(total_utilities = n(),
            paperwork_10yr = mean(paperwork_violations_10yr), 
            paperwork_5yr = mean(paperwork_violations_5yr), 
            health_10yr = mean(healthbased_violations_10yr), 
            health_5yr = mean(healthbased_violations_5yr), 
            mean_mhi = mean(estimate_mhi, na.rm = T)) %>%
  mutate(edu_level = "no_school", 
         quantile = c("0-20","20-40","40-60","60-80","80-100", "NA"))
  #   mutate(edu_bin = cut(estimate_no_school_per, edu_bin_stats)) %>%
  #   group_by(edu_bin) %>%
  #   summarize(total_utilities = n(),
  #             paperwork_10yr = mean(paperwork_violations_10yr), 
  #             paperwork_5yr = mean(paperwork_violations_5yr), 
  #             health_10yr = mean(healthbased_violations_10yr), 
  #             health_5yr = mean(healthbased_violations_5yr)) %>%
  # mutate(edu_level = "no_school")

prof <- edu_level_analysis %>%
  as.data.frame() %>%
  select(-geometry) %>%
  mutate(edu_bin = cut(estimate_prof_degree_per, 
                       breaks = c(unique(quantile(estimate_prof_degree_per, 
                                           probs = seq(0, 1, by = 0.20), 
                                           na.rm = TRUE))), 
                       include.lowest = TRUE)) %>%
  group_by(edu_bin) %>%
  summarize(total_utilities = n(),
            paperwork_10yr = mean(paperwork_violations_10yr), 
            paperwork_5yr = mean(paperwork_violations_5yr), 
            health_10yr = mean(healthbased_violations_10yr), 
            health_5yr = mean(healthbased_violations_5yr), 
            mean_mhi = mean(estimate_mhi, na.rm = T)) %>%
  mutate(edu_level = "prof_degree", 
         quantile = c(""))
  #   mutate(edu_bin = cut(estimate_prof_degree_per, edu_bin_stats)) %>%
  #   group_by(edu_bin) %>%
  #   summarize(total_utilities = n(),
  #             paperwork_10yr = mean(paperwork_violations_10yr), 
  #             paperwork_5yr = mean(paperwork_violations_5yr), 
  #             health_10yr = mean(healthbased_violations_10yr), 
  #             health_5yr = mean(healthbased_violations_5yr)) %>%
  # mutate(edu_level = "prof_degree")

edu_summaries <- rbind(prof, no_school) %>%
  relocate(quantile, .after = edu_bin)

# basic stats: 
edu_level_analysis %>%
  filter(estimate_no_school_per >= 5) %>%
  count()
edu_level_analysis %>%
  filter(estimate_prof_degree_per >= 5) %>%
  count()

# how does no schooling relate to violations??
ggplot(edu_level_analysis, aes(x = estimate_no_school_per, 
                               y = healthbased_violations_10yr)) + 
  geom_point() + 
  geom_point(aes(x = estimate_prof_degree_per), color = "darkred")

# what's the correlation between schooling and mhi?
mhi_school <- edu_level_analysis %>%
  pivot_longer(estimate_no_school_per:estimate_prof_degree_per)
mhi_school$name <- as.factor(mhi_school$name)
levels(mhi_school$name) <- c("No Schooling", "Professional Degree")
ggplot(mhi_school, aes(x = value, y = estimate_mhi)) + 
  geom_point() + 
  facet_wrap(~name) + 
  geom_smooth(color = "grey") + 
  geom_point(data = mhi_school %>% filter(healthbased_violations_5yr > 0), 
             color = "red") + 
  labs(x = "% Education Category", y = "Estimate MHI") + 
  theme_minimal()
# yay! the data make sense! 

# can we do boxplots to show comparisons with east TX:
edu_level_TX <- demo$census %>%
  select(pwsid, estimate_no_school_per:estimate_prof_degree_per) %>%
  as.data.frame() %>%
  select(-geometry)

# merging with analysis keys for main stats of interest: 
analysis_keys <- keys$analysis_keys
edu_level_analysis_TX <- merge(edu_level_TX, analysis_keys, by = "pwsid") 

edu_level_analysis_long <- edu_level_analysis %>%
  pivot_longer(estimate_no_school_per:estimate_prof_degree_per) %>%
  mutate(flag = "East TX")

edu_level_analysis_long_TX <- edu_level_analysis_TX %>%
  pivot_longer(estimate_no_school_per:estimate_prof_degree_per)%>%
  mutate(flag = "TX")

all_edu <- rbind(edu_level_analysis_long, edu_level_analysis_long_TX)
all_edu$name <- as.factor(all_edu$name)
levels(all_edu$name) <- c("No School", "Professional Degree")
ggplot(all_edu, aes(x = name, y = value, 
                    fill = flag)) + 
  geom_boxplot(alpha = 0.5) + 
  scale_fill_discrete(name = "") +
  theme_minimal()  + 
  labs(x = "", y = "Percent of Population")

# Overall summary:
# - As the % of people without schooling increases, MHI decreases
# - As the % of people with professional degrees increases, MHI increases 
#   but appears to level out after the percentage of people with prof degrees 
#   reaches ~10% 
# - 72 (1.6%) pwsids serve communities where >= 5% of the community has had no form of 
#   schooling. 
# - 54 (1.2%) pwsids serve communities where >= 5% of the community has professional 
#   degrees, and visually it appears that communities that are more educated
#   have less health-based violations 
# - Most pwsids fall within the 0-2% for both of these categories. Communities 
#   with larger % no schooling population (0.01-4)% are served by utilities with 
#   ~1 more mean health-based violation than communities where 0.01-4% have 
#   professional degrees. Interestingly, the largest mean health-based violations 
#   occurred in communities where 8-10% had professional degrees, but also only 
#   15 pwsids fell within this category. A similar rise in health-based 
#   violations was also discovered in communities with a similar % of 
#   individuals without schooling. 

#     By quantiles: 
#       - Utilities that fall within the lowest 20% quantile of professional 
#         degrees (0 - 0.05%) have the most mean health-based and paperwork 
#         violations over the past 5 years. As quantile increases in 
#         professional degrees, MHI increases. 
# 
#       - Utilities that fall within the 40-60% quantile of populations 
#         without schooling (0.65 - 1.12%) have the most mean health-based 
#         violations. As quantile increase, MHI decreases and mean paperwork 
#         violations over the past 5 and 10 years increase.  

```

## What are the population density demographics of those served? 
```{r}
# sab_census <- demo$census
pop_density <- census %>%
  select(pwsid, pop_density) %>%
  as.data.frame() %>%
  select(-geometry)

analysis_keys <- keys$analysis_keys
pop_density_analysis <- merge(pop_density, analysis_keys, by = "pwsid") 

# NOTE: there's one pwsid with a huge population density - might be a 
# mistake? Removing it for now 
# pop_density_analysis <- pop_density_analysis %>%
#   filter(pop_density != 9346644)

# plot to see where we're at: 
ggplot(pop_density_analysis, aes(x = pop_density)) + 
  geom_histogram()

# plots to investigate relationships between pop density and 
# other metrics - filtering to capture trends at most sabs: 
# how does pop density relate to % POC? 
ggplot(pop_density_analysis %>% filter(pop_density < 2500000), 
       aes(x = estimate_poc_alone_per, 
           y = pop_density)) + 
  geom_point() + 
  geom_smooth(color = "grey")+
  geom_point(data = pop_density_analysis %>% 
               filter(healthbased_violations_5yr > 0 & pop_density < 2500000), 
             color = "red") +
  geom_smooth(data = pop_density_analysis %>% 
                filter(healthbased_violations_5yr > 0 & pop_density < 2500000), 
             color = "red") +
  theme_minimal() + 
  labs(x = "% POC", y = "Population Density")

# how does pop density relate to MHI?? 
ggplot(pop_density_analysis %>% filter(pop_density < 150000), 
       aes(y = pop_density, 
           x = estimate_mhi)) + 
  geom_point() + 
  geom_smooth(color = "grey")+
  geom_point(data = pop_density_analysis %>% 
               filter(healthbased_violations_5yr > 0 & pop_density < 150000), 
             color = "red") +
  geom_smooth(data = pop_density_analysis %>% 
                filter(healthbased_violations_5yr > 0 & pop_density < 150000), 
             color = "red") + 
  theme_minimal()+ 
  labs(x = "Median Household Income", y = "Population Density")

# what about health-based violations by itself?
# ggplot(pop_density_analysis %>% filter(pop_density < 150000), 
#        aes(x = pop_density, 
#            y = healthbased_violations_5yr)) + 
#   geom_point() 

pop_density_analysis %>%
  filter(pop_density > 2500000) %>%
  count()

# checking out binned values
pop_density_bins <- c(0, 200, 500, 10000, 50000, 100000, 
                      150000, 200000, 300000, 9346644)
pop_density_analysis %>%
    as.data.frame() %>%
    select(-geometry) %>%
    mutate(pop_density_bin = cut(pop_density, pop_density_bins)) %>%
    group_by(pop_density_bin) %>%
    summarize(total_utilities = n(),
              paperwork_10yr = mean(paperwork_violations_10yr), 
              paperwork_5yr = mean(paperwork_violations_5yr), 
              health_10yr = mean(healthbased_violations_10yr), 
              health_5yr = mean(healthbased_violations_5yr)) 

# checking out data by quantles: 
pop_density_analysis %>%
    as.data.frame() %>%
    select(-geometry) %>%
  mutate(pop_density_bin = cut(pop_density, 
                             breaks = c(quantile(pop_density, 
                                                 probs = seq(0, 1, by = 0.20), 
                                                 na.rm = TRUE)), 
                             include.lowest = TRUE)) %>%
  group_by(pop_density_bin) %>%
  summarize(total_utilities = n(),
            paperwork_10yr = mean(paperwork_violations_10yr), 
            paperwork_5yr = mean(paperwork_violations_5yr), 
            health_10yr = mean(healthbased_violations_10yr), 
            health_5yr = mean(healthbased_violations_5yr), 
            mean_mhi = mean(estimate_mhi, na.rm = T)) %>%
  mutate(quantile = c("0-20","20-40","40-60","60-80","80-100"))

# Overall findings: 
# - Most utilities have a population density of 0-50,000
# - utilities with a population density between 0-10,000 and between 
#   100000 - 150000 have the highest mean health-based violations over 
#   the past 5 years, and similar trends are found if you look over the past 
#   ten years. 
# - broadly speaking - mean health-based violations are highest for systems 
#   that serve communities with small population densities - so more 
#   rural systems. 
# - Mean paperwork violations over the past 5 and ten years are highest for utilities
#   with a population density between 100000-200000 
# - By quantiles: 
#     - Utilities that fall within the lowest population density quantile 
#       (0 - 2,330) have more mean health-based violations. 
#     - Utilities that fall within the 20-40 quartile (2,330 - 7,490) 
#       have the highest mean paperwork violations over the past 5 and 10 years.  
```

## What languages are spoken by those served?
```{r}
# census <- demo$census
# grabbing language spoken at home: 
lang <- census %>%
  select(pwsid, estimate_only_english_per:estimate_other_lang_per) %>%
  as.data.frame() %>%
  select(-geometry)

analysis_keys <- keys$analysis_keys
lang_analysis <- merge(lang, analysis_keys, by = "pwsid") 

# plot to see where we're at: 
lang_analysis_long <- pivot_longer(lang_analysis, 
                                   cols = c("estimate_only_english_per", 
                                   "estimate_other_lang_per"))
ggplot(lang_analysis,
       aes(x = estimate_only_english_per)) +
  geom_histogram()

# plots to investigate relationships between language spoken at home and 
# other metrics - basically confirming stuff we already know: 
# how does this compare to % POC?
ggplot(lang_analysis, aes(x = estimate_only_english_per, 
                          y = estimate_poc_alone_per)) + 
  geom_point() + 
  geom_smooth(color = "grey") + 
  theme_minimal() +
  geom_point(data = lang_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") +
  geom_smooth(data = lang_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") + 
  labs(x = "% Only Speak English", y = "% POC") 
  # ylim(0, 80) + 
  # xlim(0, 100)

# language and mhi
ggplot(lang_analysis, aes(x = estimate_only_english_per, 
                          y = estimate_mhi)) + 
  geom_point() + 
  geom_smooth(color = "grey") + 
  theme_minimal() +
  geom_point(data = lang_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") +
  geom_smooth(data = lang_analysis %>% filter(healthbased_violations_5yr>0), 
              color = "red") + 
  labs(x = "% Only Speak English", y = "MHI") 
  # ylim(0, 300000) + 
  # xlim(0, 100)

# how does language relate to health-based viols:
ggplot(lang_analysis, aes(x = estimate_only_english_per, 
                          y = healthbased_violations_5yr)) + 
  geom_point() + 
  geom_smooth(color = "grey") + 
  theme_minimal()

# checking out binned results in table form: 
lang_analysis %>%
    as.data.frame() %>%
    select(-geometry) %>%
    mutate(lang_bin = cut(estimate_only_english_per, seq(0, 100, by = 10))) %>%
    group_by(lang_bin) %>%
    summarize(total_utilities = n(),
              paperwork_10yr = mean(paperwork_violations_10yr), 
              paperwork_5yr = mean(paperwork_violations_5yr), 
              health_10yr = mean(healthbased_violations_10yr), 
              health_5yr = mean(healthbased_violations_5yr)) 

# by quantile: 
lang_analysis %>%
  as.data.frame() %>%
  select(-geometry) %>%
  mutate(lang_bin = cut(estimate_only_english_per, 
                       breaks = c(quantile(estimate_only_english_per, 
                                           probs = seq(0, 1, by = 0.20), 
                                           na.rm = TRUE)), 
                       include.lowest = TRUE)) %>%
  group_by(lang_bin) %>%
  summarize(total_utilities = n(),
            paperwork_10yr = mean(paperwork_violations_10yr), 
            paperwork_5yr = mean(paperwork_violations_5yr), 
            health_10yr = mean(healthbased_violations_10yr), 
            health_5yr = mean(healthbased_violations_5yr), 
            mean_mhi = mean(estimate_mhi, na.rm = T)) %>%
  mutate(quantile = c("0-20","20-40","40-60","60-80","80-100", "NA")) %>%
  relocate(quantile, .after = lang_bin)

# quick stats to understand how many serve populations >= 60% speak only 
# english 
lang_analysis %>%
  filter(estimate_only_english_per >= 60) %>%
  count()

# can we do boxplots to show comparisons with east TX:
english_TX <- demo$census %>%
  select(pwsid, estimate_only_english_per) %>%
  as.data.frame() %>%
  select(-geometry)

# merging with analysis keys for main stats of interest: 
analysis_keys <- keys$analysis_keys
english_TX <- merge(english_TX, analysis_keys, by = "pwsid") %>%
  mutate(flag = "TX") %>%
  select(pwsid, estimate_only_english_per, flag)

lang_analysis <- lang_analysis %>%
  select(pwsid, estimate_only_english_per) %>%
  mutate(flag = "East TX")

all_lang <- rbind(english_TX, lang_analysis)
all_lang_long <- all_lang

ggplot(all_lang, aes(x = flag, y = estimate_only_english_per,
                    fill = flag)) + 
  geom_boxplot(alpha = 0.5) + 
  scale_fill_discrete(name = "") +
  theme_minimal()  + 
  labs(y = "Percent Speaks English at Home", x = "") + 
  theme(legend.position = "none")


# Overall findings 
#   - to no surprise, the higher % that speak English at home, the lower the 
#     % POC. Based on the trends, it also appears that systems with health-based  
#     violations are concentrated around systems that serve communities where 
#     >= 75% of the community speaks only English. 

#   - as the percentage of people that speak only English at home increases, the 
#     MHI increases 

#   - 78.8% of sabs serve communities where >= 60% of people speak only English 

#   - When a utility serves populations where 0-10% of the community speaks 
#     only english, the average number of health-based violations is highest 
#     by about 1. Another peak is found around communities where 40-50% speak 
#     only English, and generally any communties that serve communities where 
#     more than 60% of the community speaks only English, but that might again 
#     be an artifact since there are more utilities that fall into this 
#     category. 
# 
#   - By quantile:
#       - Utilities that fall within the higher quantiles (40-100) of 
#         the percent of population that speaks only english generally have 
#         more mean heath-based violations over the last 5 years and lower MHI
```

## What nationality/immigration status reflect those seved? 
```{r}
# census <- demo$census
# grabbing immigration status: 
immi_status <- census %>%
  select(pwsid, estimate_foreign_per) %>%
  as.data.frame() %>%
  select(-geometry)

# checking out what the distribution looks like: 
ggplot(immi_status, aes(x = estimate_foreign_per)) + 
  geom_histogram()

# how does immigration status relate to poc, mhi, and sdwis violations: 
analysis_keys <- keys$analysis_keys
immi_analysis <- merge(immi_status, analysis_keys, by = "pwsid") 

# logically, as % POC increases, % immigrant status increases 
ggplot(immi_analysis, aes(x = estimate_foreign_per, 
                          y = estimate_poc_alone_per)) + 
  geom_point() + 
  geom_smooth() + 
  geom_smooth(color = "grey") + 
  theme_minimal() +
  geom_point(data = immi_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") +
  geom_smooth(data = immi_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") + 
  labs(x = "% Immigrant Status", y = "%POC") 
  # xlim(0, 80) + 
  # ylim(0, 100)

# how does immigrant status relate to mhi?
ggplot(immi_analysis, aes(x = estimate_foreign_per, 
                          y = estimate_mhi)) + 
  geom_point() + 
  geom_smooth() + 
  geom_smooth(color = "grey") + 
  theme_minimal() +
  geom_point(data = immi_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") +
  geom_smooth(data = immi_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") +
  labs(x = "% Immigrant Status", y = "MHI")
  # xlim(0, 80) + 
  # ylim(0, 250000)

# checking out binned results in table form: 
immi_analysis %>%
    as.data.frame() %>%
    select(-geometry) %>%
    mutate(immi_bin = cut(estimate_foreign_per, seq(0, 100, by = 10))) %>%
    group_by(immi_bin) %>%
    summarize(total_utilities = n(),
              paperwork_10yr = mean(paperwork_violations_10yr), 
              paperwork_5yr = mean(paperwork_violations_5yr), 
              health_10yr = mean(healthbased_violations_10yr), 
              health_5yr = mean(healthbased_violations_5yr)) 

# by quantile: 
immi_analysis %>%
  as.data.frame() %>%
  select(-geometry) %>%
  mutate(immi_bin = cut(estimate_foreign_per, 
                       breaks = c(quantile(estimate_foreign_per, 
                                           probs = seq(0, 1, by = 0.20), 
                                           na.rm = TRUE)), 
                       include.lowest = TRUE)) %>%
  group_by(immi_bin) %>%
  summarize(total_utilities = n(),
            paperwork_10yr = mean(paperwork_violations_10yr), 
            paperwork_5yr = mean(paperwork_violations_5yr), 
            health_10yr = mean(healthbased_violations_10yr), 
            health_5yr = mean(healthbased_violations_5yr), 
            mean_mhi = mean(estimate_mhi, na.rm = T)) %>%
  mutate(quantile = c("0-20","20-40","40-60","60-80","80-100", "NA")) %>%
  relocate(quantile, .after = immi_bin)



# can we do boxplots to show comparisons with east TX:
immi_TX <- demo$census %>%
  select(pwsid, estimate_foreign_per) %>%
  as.data.frame() %>%
  select(-geometry)

# merging with analysis keys for main stats of interest: 
analysis_keys <- keys$analysis_keys
immi_TX <- merge(immi_TX, analysis_keys, by = "pwsid") %>%
  mutate(flag = "TX") %>%
  select(pwsid, estimate_foreign_per, flag)

immi_analysis_etx <- immi_analysis %>%
  select(pwsid, estimate_foreign_per) %>%
  mutate(flag = "East TX")

all_immi <- rbind(immi_TX, immi_analysis_etx)

ggplot(all_immi, aes(x = flag, y = estimate_foreign_per,
                    fill = flag)) + 
  geom_boxplot(alpha = 0.5) + 
  scale_fill_discrete(name = "") +
  theme_minimal()  + 
  labs(y = "% Immigrant Status", x = "") + 
  theme(legend.position = "none")

# some basic stats: 
mean(all_immi$estimate_foreign_per, na.rm = T)
median(all_immi$estimate_foreign_per, na.rm = T)

etx_immi <- all_immi %>% filter(flag == "East TX")
mean(etx_immi$estimate_foreign_per, na.rm = T)
median(etx_immi$estimate_foreign_per, na.rm = T)


# Overall findings: 
# - 83.14% of pwsids serve communities where less than 20% immigrated from a 
#   different county. 

# - to no surprise, pwsids with larger % immigrant status also have 
#   higher % POC - this is a pretty strong relationship. 

# - pwsids with larger % immigrant populations generally have smaller MHI, 
#   but this correlation is pretty weak. When looking pwsids with health-
#   based violations over the past 5 years, they tend to have lower MHI
#   and smaller % population that are immigrants. 

# - pwsids with <= 20% of the community of immigrant status generally have 
#   more health-based violations over the past 5 (and particularly 10) years, 
#   but that might be due to the fact there are more pwsids that fall into 
#   this category. Paperwork violations also tend to be higher with utilities 
#   that serve communities where small % of the community is from out of the 
#   county. 

# By quantile: 
# - Utilities that fall within the lowest quantile of % immigrant population 
#   have more mean health-based and paperwork violations over the past 5 and 10 
#   years. 
# - Utilities that fall within the highest quantile of % immigrant 
#   population have larger MHI
```

## How affordable is the water? 
```{r}
# NOTE: based on past IUPs, here is how hcf relates to principal forgiveness as
# a % of DWSRF funded project costs remaining after subtracting other 
# DWSRF princiapl forgiveness: 
# https://www.twdb.texas.gov/financial/programs/DWSRF/doc/SFY2020/SFY2020_DWSRF_IUP.pdf
#   - hcf difference
#       - >=0 and < 1.5% --> 30% 
#       - >= 1.5 and < 3 % --> 50% 
#       - >= 3% --> 70%

# NOTE: data here are also conservative - hcf is further modified by 
# unemployment rate hcf and population decline hcf, which can only 
# increase the chance of being identified as disadvantaged 

# NOTE: the water affordability data is NOT comprehensive - only has ~706 
# unique pwsids 
# aff <- fin$TX_affordability_DAC %>%
#   as.data.frame() %>%
#   select(-c(geometry, estimate_mhi))

# how does hcf  relate to poc, mhi, and sdwis violations: 
analysis_keys <- keys$analysis_keys
aff_analysis <- merge(aff, analysis_keys, by = "pwsid") 

# how does household cost factor relate to %POC?
ggplot(aff_analysis, aes(x = hcf*100, 
                          y = estimate_poc_alone_per)) + 
  geom_point() + 
  geom_smooth() + 
  geom_smooth(color = "grey") + 
  theme_minimal() +
  geom_point(data = aff_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") +
  geom_smooth(data = aff_analysis %>% filter(healthbased_violations_5yr>0), 
             color = "red") + 
  labs(x = "Household Cost Factor", y = "%POC") 
  # xlim(0, 5) + 
  # ylim(0, 85)
  # geom_vline(xintercept= c(0, 1.5, 3), lty = "dashed")

# how does household cost factor relate to MHI?
# that ~makes sense~ since mhi was used to calculate MHI - this graph 
# might be useless 
ggplot(aff_analysis, aes(x = hcf*100,
                          y = estimate_mhi)) +
  geom_point() +
  geom_smooth() +
  geom_smooth(color = "grey") +
  theme_minimal() +
  geom_point(data = aff_analysis %>% filter(healthbased_violations_5yr>0),
             color = "red") +
  geom_smooth(data = aff_analysis %>% filter(healthbased_violations_5yr>0),
             color = "red")  + 
  labs(x = "Household Cost Factor", y = "MHI")
  # xlim(0, 5) + 
  # ylim(0, 250000)

# how does hcf relate to health-based violations? 
ggplot(aff_analysis, aes(x = hcf, 
                          y = healthbased_violations_5yr)) + 
  geom_point() + 
  geom_smooth(color = "grey") + 
  theme_minimal() +
  # geom_point(data = aff_analysis %>% filter(healthbased_violations_5yr>0), 
  #            color = "red") +
  # geom_smooth(data = aff_analysis %>% filter(healthbased_violations_5yr>0), 
  #            color = "red") + 
  labs(x = "Household Cost Factor", y = "Health-based Violations: 5 years")

# mean and median: 
mean(aff_analysis$hcf*100, na.rm = T)
median(aff_analysis$hcf*100, na.rm = T)

# checking out binned results in table form: 
aff_analysis %>%
    as.data.frame() %>%
    select(-geometry) %>%
    mutate(aff_bin = cut(hcf, c(0, 0.01, 0.02, 0.03, 0.04, 0.05))) %>%
    group_by(aff_bin) %>%
    summarize(total_utilities = n(),
              paperwork_10yr = mean(paperwork_violations_10yr), 
              paperwork_5yr = mean(paperwork_violations_5yr), 
              health_10yr = mean(healthbased_violations_10yr), 
              health_5yr = mean(healthbased_violations_5yr)) 

# by quantile: 
aff_analysis %>%
  as.data.frame() %>%
  select(-geometry) %>%
  mutate(aff_bin = cut(hcf, 
                       breaks = c(quantile(hcf, 
                                           probs = seq(0, 1, by = 0.25), 
                                           na.rm = TRUE)), 
                       include.lowest = TRUE)) %>%
  group_by(aff_bin) %>%
  summarize(total_utilities = n(),
            paperwork_10yr = mean(paperwork_violations_10yr), 
            paperwork_5yr = mean(paperwork_violations_5yr), 
            health_10yr = mean(healthbased_violations_10yr), 
            health_5yr = mean(healthbased_violations_5yr), 
            mean_mhi = mean(estimate_mhi, na.rm = T), 
            mean_poc = mean(estimate_poc_alone_per, na.rm = T)) %>%
  mutate(quantile = c("0-25","25-50","50-75","75-100", "NA")) %>%
  relocate(quantile, .after = aff_bin)


# gotta map this: 
aff_analysis_sf <- aff_analysis %>%
  st_as_sf() %>%
  st_transform(., crs = st_crs(demo$census))

# mapping the number of violations in TX: 
viol_pal <- colorBin(
  palette = c("#003049","#6b2c39", "#d62828", "#f77f00", "#fcbf49"),
  bins = c(1, 5, 10, 50, 100, 200), 
  na.color = "#c9c9bc")

leaflet() %>%
  addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite") %>%
  addPolygons(data = viols,
              fillOpacity = 0.9,
              # fillOpacity = 0.9,
              # stroke = TRUE,
              # color = "black",
              color = ~viol_pal(healthbased_violations_5yr))

# mapping household cost factor across TX: 
hcf_pal <- colorNumeric(
  palette = c("#003049","#6b2c39", "#d62828", "#f77f00", "#fcbf49"),
  domain = aff_analysis_sf$hcf*100)

leaflet() %>%
  addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite") %>%
  addPolygons(data = aff_analysis_sf,
              fillOpacity = 0.9,
              # opacity = 9,
              color = ~hcf_pal(hcf*100),
              weight = 1,
              label = paste0("pwsid: ", aff_analysis_sf$pwsid,
                "; hcf: ", round(aff_analysis_sf$hcf, 2))) %>%
  addLegend("bottomright",
            pal = hcf_pal,
            values = aff_analysis_sf$hcf*100,
            title = "HCF",
            opacity = 1)

# mapping water rates in TX: 
aff_analysis_sf <- aff_analysis_sf %>%
  mutate(total_water = total_water_year + total_sewer_year)
water_rate_pal <- colorNumeric(
  palette = c("#003049","#6b2c39", "#d62828", "#f77f00", "#fcbf49"),
  domain = aff_analysis_sf$total_water)

leaflet() %>%
  addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite") %>%
  addPolygons(data = aff_analysis_sf, 
                # filter(east_tx_flag == "yes"),
                # 
              fillOpacity = 0.9,
              # opacity = 9,
              color = ~water_rate_pal(total_water),
              weight = 1,
              label = paste0("pwsid: ", aff_analysis_sf$pwsid,
                "; hcf: ", round(aff_analysis_sf$total_water, 2))) %>%
  addLegend("bottomright",
            pal = water_rate_pal,
            values = aff_analysis_sf$total_water,
            title = "Annual Water Rate (Water + Sewer; $)",
            opacity = 1)

# grabbing mean stats for water afforability in TX and east TX: 
mean(aff_analysis_sf$total_water_year)
mean(aff_analysis_sf$total_sewer_year)
median(aff_analysis_sf$total_water_year)
median(aff_analysis_sf$total_sewer_year)

etx_aff <- aff_analysis_sf %>%
  filter(east_tx_flag == "yes")

mean(etx_aff$total_water_year)
mean(etx_aff$total_sewer_year)
median(etx_aff$total_water_year)
median(etx_aff$total_sewer_year)

# how does this compare to mhi? creating a map of MHI across east TX: 
census <- demo$census %>%
  filter(east_tx_flag == "yes")
mhi_pal <- colorNumeric(
  palette = viridis::viridis(9),
  domain = census$estimate_mhi)

leaflet() %>%
  addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite") %>%
  addPolygons(data = census,
              fillOpacity = 0.9,
              # opacity = 9,
              stroke = TRUE, 
              color = "black", 
              # color = ~mhi_pal(estimate_mhi),
              fillColor = ~mhi_pal(estimate_mhi),
              
              weight = 1,
              label = paste0("pwsid: ", aff_analysis_sf$pwsid,
                             "; hcf: ", round(aff_analysis_sf$total_water_year, 2))) %>%
  addLegend("bottomright",
            pal = mhi_pal,
            values = census$estimate_mhi,
            title = "MHI",
            opacity = 1)


# can we do boxplots to show comparisons with east TX:
hcf_TX <- fin$TX_affordability_DAC %>%
  select(pwsid, hcf) %>%
  as.data.frame() %>%
  select(-geometry) %>%
  mutate(flag = "TX")

# merging with analysis keys for main stats of interest: 
e_pwsids <- keys$analysis_keys %>%
  filter(east_tx_flag == "yes")

hcf_eTX <- aff_analysis %>%
  as.data.frame() %>%
  select(-geometry) %>%
  filter(pwsid %in% e_pwsids$pwsid) %>%
  select(pwsid, hcf) %>%
  mutate(flag = "East TX")

all_hcf <- rbind(hcf_eTX, hcf_TX)

ggplot(all_hcf, aes(x = flag, y = hcf*100,
                    fill = flag)) + 
  geom_boxplot(alpha = 0.5) + 
  scale_fill_discrete(name = "") +
  theme_minimal()  + 
  labs(y = "Household Cost Factor", x = "") + 
  theme(legend.position = "none")

# what does the cost of water look like in comparison to MHI?
ggplot(aff_analysis, aes(x = total_water_year + 
                           total_sewer_year,
                          y = estimate_mhi)) +
  geom_point() +
  geom_smooth() +
  geom_smooth(color = "grey") +
  theme_minimal() +
  geom_point(data = aff_analysis %>% filter(healthbased_violations_5yr>0),
             color = "red") +
  geom_smooth(data = aff_analysis %>% filter(healthbased_violations_5yr>0),
             color = "red")  + 
  labs(x = "Annual Water Cost (Water + Sewer)", y = "MHI")


# Overall findings: 
# - utilities that serve communities where the water is less affordable 
#   (hcf > 0.02), have strikingly higher mean health-based violations 
#   over the past 5 and 10 years. Mean values are particularly high 
#   between 0.02-0.03 but that might be due to the outlier that had 
#   ~182 (!!!!!) health-based violations over the past five years. 

# - when plotting the data spatially, large cities generally 
#   have low hcf, but rural communities have higher hcf. 

# By quantiles: 
# Utilities that fall into the highest quantile of hcf (0.019 - 0.0449) have 
# the lowest MHI, generally lower %POC,  and the most health-based violations 
# over the past five and ten years. 

```

## Bonus look at stats for cws in TX and comparisons across different scales: 
```{r}
# grabbing stats at different scales: 
census <- demo$census
east_tx_cws <- census %>%
  filter(east_tx_flag == "yes")
sum(census$estimate_total_pop, na.rm = T)
sum(east_tx_cws$estimate_total_pop, na.rm = T)

summary(east_tx_cws)

# how does this compare to all of Texas?
census_vars <- c(total_pop = "B01003_001",
                 black_alone = "B02001_003", 
                 asian_alone = "B02001_005", 
                 white_alone = "B02001_002", 
                 AIAN_alone = "B02001_004", 
                 NAPI_alone = "B02001_006", 
                 other_alone = "B02001_007", 
                 mixed_alone = "B02001_008",
                 hisp_alone = "B03003_003", 
                 mhi = "B19013_001", 
                 under_6  = "B23008_002", 
                 over_65 = "B09021_022", 
                 only_english = "B99162_002", 
                 other_lang = "B99162_003", 
                 no_school = "B15003_002", 
                 prof_degree = "B15003_024", 
                 foreign = "B99051_005", 
                 pov_level_at_above_150 = "B06012_004")
tx_census <- tidycensus::get_acs(
  geography = "state", 
  variables = census_vars, 
  state = c("TX"), # also wanted to grab stats for Texarkana  
  year = 2021,
  geometry = TRUE
)

# stats for all of TX: 
tx_wide <- pivot_wider(tx_census, 
                           names_from = c("variable"), 
                           values_from = c("estimate", "moe"))

tx_wide <- tx_wide %>%
  select(starts_with(c("estimate"))) %>%
  # leaving out columns that are totals or mhi:
  mutate_at(vars(!c("estimate_total_pop", "estimate_mhi")), 
            ~((./estimate_total_pop)*100)) %>%
  mutate(estimate_poc_alone = (100 - estimate_white_alone))


# grabbing East TX stats: 
etx_census <- tidycensus::get_acs(
  geography = "county", 
  variables = census_vars, 
  state = c("TX"), # also wanted to grab stats for Texarkana  
  year = 2021,
  geometry = TRUE
)

counties <- unlist(strsplit(etx_census$NAME, split = ","))
etx_census$counties <- trimws(counties[grepl("County", counties)])

east_tx <- read.csv("./data/raw/east_TX_counties.csv") %>%
  select(-X) %>%
  mutate(county_tidy = paste0(county_name, " County"))
# running an intersection with east TX geography
east_tx_geo <- etx_census %>%
  filter(counties %in% east_tx$county_tidy) 

etx_wide <- pivot_wider(east_tx_geo, 
                       names_from = c("variable"), 
                       values_from = c("estimate", "moe"))

etx_wide <- etx_wide %>%
  select(starts_with(c("estimate"))) %>%
  # leaving out columns that are totals or mhi:
  mutate_at(vars(!c("estimate_total_pop", "estimate_mhi")), 
            ~((./estimate_total_pop)*100)) %>%
  mutate(estimate_poc_alone = (100 - estimate_white_alone))

summary(etx_wide)
sum(etx_wide$estimate_total_pop)
```
Rabbit holes: 
 - deeper dive into education categories - basically just have no schooling and prof degrees at the moment
- investigate relationship between hcf (water affordability), and population density. Based on the map, I have an inkling that they may be related. 