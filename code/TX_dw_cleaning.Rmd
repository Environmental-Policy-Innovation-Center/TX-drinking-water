---
title: "TX Water Data Cleaning & Processing"
output: html_document
date: "2023-12-07"
author: "EmmaLi Tsai" 
---

Packages: 
```{r}
library(tidyverse)
library(leaflet)
library(sf)
library(aws.s3)
library(janitor)
library(rvest)
library(tidycensus)
library(areal)
```

Sourcing downloaders: 
```{r}
source("~/TX-drinking-water/code/download_handlers/download_sabcrosswalk.R")
source("~/TX-drinking-water/code/download_handlers/download_SDWIS.R")
```

Grabbing data from APIs: 
```{r}
# grabbing sabs: 
TX_sab <- download_sab(states = c("TX"))
# making note the of the pwsids located in TX: 
TX_pwsids <- unique(TX_sab$pwsid)

# grabbing block crosswalks from the pwsids: taken out due to issues here 
# TX_cross <- download_blockcrosswalk(pwsids = TX_pwsids)

# grabbing SDWIS data - currently looking at Fluoride and Chlorine violations 
# (1025 and 0999 respectively)
TX_sdwis <- download_SDWIS(pwsids = TX_pwsids, 
                           cont_code = c("1025", "0999"))

# census data - grabbing block group stats for now 
# vars_acs <- load_variables(year = 2021, "acs5")
census_vars <- c(total_pop = "B01003_001",
                black_alone = "B02001_003", 
                asian_alone = "B02001_005", 
                white_alone = "B02001_002", 
                AIAN_alone = "B02001_004", 
                NAPI_alone = "B02001_006", 
                other_alone = "B02001_007", 
                mixed_alone = "B02001_008",
                hisp_alone = "B03003_003", 
                mhi = "B19013_001", 
                under_6  = "B23008_002", 
                over_65 = "B09021_022", 
                only_english = "B99162_002", 
                other_lang = "B99162_003", 
                no_school = "B15003_002", 
                prof_degree = "B15003_024", 
                foreign = "B99051_005")
TX_census <- tidycensus::get_acs(
  geography = "block group", 
  variables = census_vars, 
  state = unique(TX_sab$state_code), 
  year = 2021,
  geometry = TRUE
)
```

Data merging & crosswalking: 
```{r}
## Grabbing race statistics for pwsids: ########################################
# TODO: change this to areal interpolation methods 
# TODO: Flag for rural or non-rural here? 

# adding counties: 
TX_census_tidy <- TX_census
counties <- unlist(strsplit(TX_census_tidy$NAME, split = ","))
TX_census_tidy$counties <- trimws(counties[grepl("County", counties)])

# tidying census data and crs transformation: 
TX_census_wide <- pivot_wider(TX_census_tidy, 
                              names_from = c("variable"), 
                              values_from = c("estimate", "moe"))  %>%
  st_transform(crs="ESRI:102296")
# sab crs transformation: 
TX_sab_tidy <- TX_sab %>%
  st_transform(crs="ESRI:102296")

# sab and block group areal interpolation - note this takes quite a bit of time 
# to run
# TODO: brainstorm how to recalculate moe and mhi.. summing them seems incorrect. 
# possibly need to do a separate interpolation method here? 
census_vars <- names(TX_census_wide)
varList <- census_vars[grepl("estimate", census_vars)]
areal::ar_validate(source = TX_census_wide,
                   target = TX_sab_tidy,
                   varList = varList,
                   method="aw",
                   verbose=TRUE)
sab_interpolate_bg <- aw_interpolate(TX_sab_tidy, tid="pwsid", 
                                     source=TX_census_wide, 
                                     sid="GEOID", weight="sum", 
                                     output="sf", 
                                     extensive= varList)
# calculating percentage across census vars: 
pwsid_census_percents <- sab_interpolate_bg %>%
  as.data.frame(.) %>%
  select(starts_with(c("estimate", "pwsid"))) %>%
  select(-c("estimate_mhi")) %>%
  mutate_at(vars(!c("estimate_total_pop", "pwsid")), ~((./estimate_total_pop)*100)) %>%
  relocate("pwsid") %>%
  mutate(esimate_poc_alone = (100 - pwsid_census_percents$estimate_white_alone))
# renaming columns for merging purposes: 
colnames(pwsid_census_percents) <- paste0(colnames(pwsid_census_percents), "_per")

# merging this back into the original interpolation: 
sab_census <- merge(sab_interpolate_bg, pwsid_census_percents, 
      by.x = "pwsid", by.y = "pwsid_per")

## Merging SDWIS, sabs, census ################################################# 
# TODO: add some more SDWIS stats at this step (i.e, year, decade, length of 
# violation, etc.)
TX_census_sdwis <- merge(TX_pwsid_census_tidy, TX_sdwis, all = T)

## NOTE: this could then write to the data lake using the aws functions 
# contains pwsid-level demographic information and SDWIS violations
```

Maps & Plots (QA/QC)
```{r}
## QA/QC #####################################################################
# TODO: add how many pwsids have SDWIS and census population deltas greater 
# than X
# TODO: this will also need to be fixed with updates as of 1/9/23

# creating a diagnostic log: 
diag_log <- data.frame(diagnostic = "") %>%
  mutate(na_pwsid = sum(is.na(TX_pwsid_census_tidy$pwsid)), 
         na_serv_connections = sum(is.na(TX_pwsid_census_tidy$service_connections_count)),
         na_sdwis_pop = sum(is.na(TX_pwsid_census_tidy$population_served_count)), 
         zero_sdwis_pop = sum(TX_pwsid_census_tidy$population_served_count == 0, 
                              na.rm = TRUE), 
         zero_area = sum(TX_pwsid_census_tidy$area_miles == 0,
                         na.rm = TRUE), 
         zero_pop_density = sum(TX_pwsid_census_tidy$pop_density %in% c(0, "NaN", "Inf"),
                                na.rm = TRUE), 
         na_cesus_pop = sum(is.na(TX_pwsid_census_tidy$total_pop)), 
         zero_census_pop = sum(TX_pwsid_census_tidy$total_pop == 0, 
                               na.rm = TRUE), 
         empty_geoms = sum(sf::st_is_empty(TX_pwsid_census_tidy))) %>%
  # TODO: insert some stats for PPL and SDWIS stats here
  select(-diagnostic) %>%
  pivot_longer(., cols = everything())

# how does our pwsids compare to other websites? 
# 4552 sabs based on: https://www3.twdb.texas.gov/apps/waterserviceboundaries
# length(unique(TX_sab$pwsid))  # 4586 but the website above might've filtered 
# data that have at least 15 service connections or serve at least 
# 25 people at least 60 days out of the year 

## Map of pwsids and % poc ####################################################
# converting to sf, transformations, and filtering 
TX_pwsid_census_tidy <- st_as_sf(TX_pwsid_census_tidy)
TX_pwsid_census_tidy <- st_transform(TX_pwsid_census_tidy, 
                                         '+proj=longlat +datum=WGS84')
TX_pwsid_census_tidy <- TX_pwsid_census_tidy %>% 
  filter(!st_is_empty(.))

# plotting: 
poc_pal <- colorNumeric(
  palette = viridis::turbo(6),
  domain = TX_pwsid_census_tidy$poc_alone)
leaflet() %>%
  addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite")  %>%
  addPolygons(data = TX_pwsid_census_tidy, 
              opacity = 9,
              color = ~poc_pal(poc_alone),
              weight = 1, 
              highlightOptions = highlightOptions(color = "grey", weight = 2,
                                                  bringToFront = TRUE), 
              label = paste0("pwsid: ", TX_pwsid_census_tidy$pwsid, 
                             " / poc %: ", 
                             round(TX_pwsid_census_tidy$poc_alone*100, 2))) %>%
    addLegend("bottomright", 
            pal = poc_pal, 
            values = TX_pwsid_census_tidy$poc_alone,
            title = "% POC",
            opacity = 1)

## Map of pwsids and # SDWIS violations ########################################
# finding the total number of violations (need to also standardize for year and
# how long the system has been operating for):
TX_violations <- TX_sdwis %>%
  group_by(pwsid, primary_source_code) %>%
  summarize(total_viol = length(unique(violation_id)))
# grabbing geoms for mapping: 
TX_violations_tidy <- merge(TX_sab[,c("pwsid")], TX_violations, all = T)

# map of total number of violations for pwsid: 
viol_pal <- colorNumeric(
  palette = viridis::plasma(6),
  domain = TX_violations_tidy$total_viol)
leaflet() %>%
  addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite")  %>%
  addPolygons(data = TX_violations_tidy, 
              opacity = 9,
              color = ~viol_pal(total_viol),
              weight = 1, 
              highlightOptions = highlightOptions(color = "grey", weight = 2,
                                                  bringToFront = TRUE), 
              label = paste0("pwsid: ", TX_violations_tidy$pwsid, 
                             " / violations: ", TX_violations_tidy$total_viol)) %>%
    addLegend("bottomright", 
            pal = viol_pal, 
            values = TX_violations_tidy$total_viol,
            title = "# violations",
            opacity = 1)

# SDWIS violations by POC: 
# ggplot(TX_census_sdwis, aes(x = poc_alone, y = (violation_id), color = pwsid)) + 
#   geom_point() + 
#   theme_bw() + 
#   theme(legend.position = "none")
```

_______________________________________________________________________________
Loading in TX data
```{r}
# PPL data & tidying 
TX_PPL <- aws.s3::s3read_using(read.csv, object = "s3://water-team-data/clean_data/srf_project_priority_lists/web_ppl_combined_clean_v1-1.csv") %>%
  mutate(across('Project.Type', 
                str_replace, 'Other', 'General')) %>%
  filter(State == "Texas") %>%
  janitor::clean_names()

# # merging census, sdwis, and ppl data into one mega data frame: 
# TX_cen_sdwis_ppl <- merge(TX_census_sdwis, TX_ppl_tidy, by = "pwsid", 
#                           all = TRUE)
# 

# attempting to read groundwater data from TWDB
# gw <- read_sf("./data/state_raw/TWDB_Groundwater/TWDB_Groundwater.shp")
# leaflet() %>%
#   addProviderTiles(providers$CartoDB.VoyagerNoLabels, group = "Toner Lite")  %>%
#   addMarkers(data = gw)



```


East TX 
```{r}
# webpage scraping for TX counties in East Texas: 
url <- "https://www.east-texas.com/east-texas-county-governments.htm"
tx_counties_list <- url %>% 
  read_html() %>% 
  html_nodes("table") %>% 
  html_table(fill = T) 
# cleaning: 
east_TX_counties <- tx_counties_list[[4]] %>%
  janitor::row_to_names(row_number = 1) %>%
  janitor::clean_names() %>%
  filter(county_name != "Total - 38 Counties")
```